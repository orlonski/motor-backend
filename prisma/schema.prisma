// Schema Prisma MELHORADO
// Mudan칞as marcadas com // 游 NOVO ou // 九勇 MODIFICADO

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid()) @db.Uuid
  username  String   @unique @db.VarChar(100)
  password  String   @db.VarChar(255)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz()

  @@map("users")
}

model Integration {
  id          String        @id @default(uuid()) @db.Uuid
  name        String        @db.VarChar(255)
  description String?       @db.Text
  createdAt   DateTime      @default(now()) @map("created_at") @db.Timestamptz()
  endpoints   ApiEndpoint[]

  @@map("integrations")
}

model ApiEndpoint {
  id                 String         @id @default(uuid()) @db.Uuid
  integrationId      String         @map("integration_id") @db.Uuid
  name               String         @db.VarChar(255)
  httpMethod         String         @map("http_method") @db.VarChar(10)
  url                String         @db.Text
  headersTemplate    Json?          @map("headers_template") @db.JsonB
  authenticationType String         @default("None") @map("authentication_type") @db.VarChar(50)
  createdAt          DateTime       @default(now()) @map("created_at") @db.Timestamptz()
  integration        Integration    @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  requestType        String         @default("REST") @map("request_type") @db.VarChar(10)
  bodyTemplate       String?        @map("body_template") @db.Text
  
  // 游 NOVOS CAMPOS: Exemplos de estrutura para valida칞칚o
  requestExample     Json?          @map("request_example") @db.JsonB  // Exemplo do payload de request
  responseExample    Json?          @map("response_example") @db.JsonB // Exemplo do payload de response (COMPLETO)
  mappedResponseExample Json?       @map("mapped_response_example") @db.JsonB // Exemplo de response FILTRADO (apenas campos mapeados)
  
  // 游 NOVO: Metadados de detec칞칚o autom치tica
  detectedScenario   String?        @map("detected_scenario") @db.VarChar(50) // 'simple_object', 'array_root', 'object_with_arrays'
  lastTestedAt       DateTime?      @map("last_tested_at") @db.Timestamptz() // 칔ltima vez que testou a API
  
  fieldMappings      FieldMapping[]
  // 游 NOVA RELA칂츾O
  validationErrors   ValidationError[]

  @@map("api_endpoints")
}

model FieldMapping {
  id         String      @id @default(uuid()) @db.Uuid
  endpointId String      @map("endpoint_id") @db.Uuid
  direction  String      @db.VarChar(10) // 'request' ou 'response'
  sourcePath String      @map("source_path") @db.Text
  targetPath String      @map("target_path") @db.Text
  createdAt  DateTime    @default(now()) @map("created_at") @db.Timestamptz()
  
  // 游 NOVOS CAMPOS: Valida칞칚o e metadados
  isValid    Boolean     @default(true) @map("is_valid") @db.Boolean // Se o mapping est치 v치lido
  validatedAt DateTime?  @map("validated_at") @db.Timestamptz() // 칔ltima valida칞칚o
  
  endpoint   ApiEndpoint @relation(fields: [endpointId], references: [id], onDelete: Cascade)

  @@map("field_mappings")
}

// 游 NOVA TABELA: Hist칩rico de erros de valida칞칚o
model ValidationError {
  id          String      @id @default(uuid()) @db.Uuid
  endpointId  String      @map("endpoint_id") @db.Uuid
  errorType   String      @map("error_type") @db.VarChar(100) // 'MULTIPLE_ROOT_ARRAYS', 'INVALID_PATH', etc
  errorMessage String     @map("error_message") @db.Text
  suggestion  String?     @db.Text // Sugest칚o de corre칞칚o
  sourcePath  String?     @map("source_path") @db.Text // Path que causou o erro
  targetPath  String?     @map("target_path") @db.Text
  severity    String      @db.VarChar(20) // 'error', 'warning', 'info'
  resolved    Boolean     @default(false) @db.Boolean // Se o erro foi corrigido
  createdAt   DateTime    @default(now()) @map("created_at") @db.Timestamptz()
  
  endpoint    ApiEndpoint @relation(fields: [endpointId], references: [id], onDelete: Cascade)

  @@map("validation_errors")
}